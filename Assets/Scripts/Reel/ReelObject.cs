using ReelSpinGame_Reels;
using ReelSpinGame_Reels.ReelArray;
using System;
using UnityEngine;

public class ReelObject : MonoBehaviour
{
    // リールオブジェクト

    // const

    // 図柄変更時の角度 (360度を21分割)
    const float ChangeAngle = 360.0f / 21.0f;

    // 回転速度 (Rotate Per Second)
    public const float RotateRPS = 79.7f / 60.0f;

    // リール重さ(kg)
    public const float ReelWeight = 25.5f;

    // リール半径(cm)
    public const float ReelRadius = 12.75f;


    // var

    // 現在の回転速度
    private float rotateSpeed = 0.0f;

    // 最高速度
    private float maxSpeed = 0.0f;

    //[SerializeField] REEL_COLUMN_ID reelID;
    private SymbolChange[] symbolsObj;

    // リール情報を持つ
    public ReelData ReelData { get; private set; }

    bool isSpinning = false;

    void Awake()
    {
        symbolsObj = GetComponentsInChildren<SymbolChange>();
        Debug.Log("ReelSpin AwakeDone");
    }

    private void Start()
    {
        UpdateSymbolsObjects();
        Debug.Log("StartDone");

        StartReel(1.0f);
    }

    void FixedUpdate()
    {
        if(isSpinning)
        {
            if (rotateSpeed <= maxSpeed) { AccerateReelSpeed(); }
            RotateReel();
        }
    }

    // リールデータを渡す
    public void SetReelData(ReelData reelData) => ReelData = reelData;

    //　リール始動
    public void StartReel(float maxSpeed)
    {
        isSpinning = true;
        this.maxSpeed = maxSpeed;
    }

    // 速度加速
    void AccerateReelSpeed()
    {
        Math.Clamp(rotateSpeed += ReturnReelAccerateSpeed(RotateRPS) * Math.Sign(maxSpeed), 
            -1 * maxSpeed, maxSpeed);
    }

    // リール回転
    void RotateReel()
    {
        transform.Rotate((ReturnAngularVelocity(RotateRPS)) * Time.deltaTime * rotateSpeed * Vector3.left);

        // 一定角度に達したら図柄の更新(17.174 or 342.826)
        if ((Math.Abs(transform.rotation.eulerAngles.x) <= 360.0f - ChangeAngle && rotateSpeed > 0) ||
            (Math.Abs(transform.rotation.eulerAngles.x) >= ChangeAngle && rotateSpeed < 0))
        {
            ReelData.ChangeReelPos(rotateSpeed);
            UpdateSymbolsObjects();

            Debug.Log("Changed Symbol");

            transform.Rotate(Vector3.right, ChangeAngle * Math.Sign(rotateSpeed));

            /*if (reelData.WillStop && reelData.CurrentDelay == 0)
            {
                reelData.ChangeSpinState(false);
                //Recalculate the rotation
                transform.Rotate(Vector3.left, Math.Abs(transform.rotation.eulerAngles.x));
                rotateSpeed = 0;
            }
            else if (reelData.WillStop){reelData.DecrementDelay(); }*/
        }
    }

    //図柄の更新
    private void UpdateSymbolsObjects()
    {
        // 現在のリール下段を基準として位置を更新する。
        foreach(SymbolChange symbol in symbolsObj)
        {
            symbol.ChangeSymbol(ReelData.Array[ReelData.GetReelPos(symbol.GetPosID())]);
            Debug.Log("Changed Symbol:" + ReelData.Array[ReelData.GetReelPos(symbol.GetPosID())]);
        }
    }

    // 回転率計算
    private float ReturnAngularVelocity(float rpsValue)
    {
        //Radian
        float radian = rpsValue * 2.0f * MathF.PI;
        //ConvertRadian to angle per seconds
        return radian * 180.0f / MathF.PI;
    }

    // 加速度を返す
    private float ReturnReelAccerateSpeed(float rpsValue)
    {
        return ReelRadius / 100f * ReturnAngularVelocity(rpsValue) / 1000.0f;
    }
}
